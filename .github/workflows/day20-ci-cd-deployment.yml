name: day20-artifact-deploy

on:
  push:
    branches: [ "ci/cd-github-actions" ]
  pull_request:
    branches: [ "ci/cd-github-actions" ]

env:
  BUCKET: "day20-demo-oubt"
  AWS_REGION: "us-east-1" 

jobs:
  upload-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload Glue and Lambda scripts to S3
        run: |
          set -euo pipefail

          # Uploading Glue Scripts to /scripts/glue/
          declare -A GLUE_FILES=(
            [day20/glue/day20-quality-score-card.py]=day20-quality-score-card.py
            [day20/glue/day20-export-to-redshift.py]=day20-export-to-redshift.py
            [day20/glue/day20-processed-curated.py]=day20-processed-curated.py
            [day20/glue/day20-processed-mdm.py]=day20-processed-mdm.py
            [day20/glue/day20-raw-processed-dimension-tables.py]=day20-raw-processed-dimension-tables.py
            [day20/glue/day20-raw-processed.py]=day20-raw-processed.py
          )

          for SRC in "${!GLUE_FILES[@]}"; do
            DST="s3://${BUCKET}/scripts/glue/${GLUE_FILES[$SRC]}"
            if [ -f "$SRC" ]; then
              echo "Uploading Glue Script: ${SRC} -> ${DST}"
              aws s3 cp "$SRC" "$DST"
            else
              echo "Warning: Glue file ${SRC} not found."
            fi
          done

          # Uploading Lambda Scripts to /scripts/lambda/
          LAMBDA_SRC="day20/lambda/day20-lambda-validate-raw-file.py"
          LAMBDA_DST="s3://${BUCKET}/scripts/lambda/day20-lambda-validate-raw-file.py"
          
          if [ -f "$LAMBDA_SRC" ]; then
            echo "Uploading Lambda Script: ${LAMBDA_SRC} -> ${LAMBDA_DST}"
            aws s3 cp "$LAMBDA_SRC" "$LAMBDA_DST"
          fi

      - name: Final S3 Audit
        run: |
          echo "Current deployment state in S3:"
          aws s3 ls "s3://${BUCKET}/scripts/" --recursive